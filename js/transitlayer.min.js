function pad(t,e){return(1e15+t+"").slice(-e)}window.TransitLayer=function(t){this._MIN_MULTIPLICATOR=.5,this._MAX_MULTIPLICATOR=120,this._LOOKAHEADSECONDS=20,this._startTime=t.time,this._animationStartTime=(new Date).getTime(),this._curHighLight=void 0,this._multiplicator=1,this._updateTimeStep=50,this._timeStep=this._updateTimeStep,this._markers={},this._loadPerCycle=1e3,this._newLoadPerCycle=1e3,this._vehiclePosUpdateLock=!1,this._lastTrajectoriesRID=0,this._trajectoryClient=null,this._vehicleSelectListeners=new Array,this._timeChangeListeners=new Array,this._curTimeZone={os:0,c:"UTC"},this._selectedVeh=void 0,this._vehicleCounter=0,this._statMode=t.statMode,this._vehicleTypes=new Array("Tram","Subway / Metro / S-Bahn","Train","Bus","Ferry","Cable Car","Gondola","Funicular"),this._standardBgColor=new Array("#ffb400","#ff5400","#b5b5b5","#b5b5b5","#3000ff","#ffb400","#ffffff","#ffffff"),this._standardTextColor=new Array("#000000","#ffffff","#000000","#000000","#3000ff","#000000","#000000","#000000"),this._timeStepArray=new Array(1e4,1e4,1e4,1e4,1e4,1e4,1e4,5e3,3e3,2e3,1e3,500,400,250,170,140,120,110,85,60,50),this._padding=10,this._pulseEnabled=!1,this._oldTime=this._getCurTime(),this._currentTimeSum=0,this._currentTimeSampleCounter=0},TransitLayer.prototype.init=function(t){this._raphaelRoot=t,this._paper=Raphael(this._raphaelRoot)},TransitLayer.prototype.start=function(){this._requestTrajectories()},TransitLayer.prototype._onMoveEnd=function(){this._timeStep=this._updateTimeStep,this._newLoadPerCycle=1e3,clearTimeout(this._partialTrajLoadTimer),this._requestTrajectories(!0),void 0!==this._curHighLight&&this.showVehicleTraj(this._curHighLight,!0)},TransitLayer.prototype._onMoveStart=function(){clearTimeout(this._partialTrajLoadTimer),this._loadPerCycle=100,this._newLoadPerCycle=100,this._updtVehTrajs()},TransitLayer.prototype._onZoomStart=function(){clearTimeout(this._partialTrajLoadTimer),this._paper.clear(),this._markers={}},TransitLayer.prototype.onRemove=function(){this._paper.clear(),this._markers={},clearTimeout(this._partialTrajLoadTimer)},TransitLayer.prototype.getTimeZone=function(){return this._curTimeZone},TransitLayer.prototype.getCurTime=function(){return this._oldTime},TransitLayer.prototype.getMultiplicator=function(){return this._multiplicator},TransitLayer.prototype.setMultiplicator=function(t){t<this._MIN_MULTIPLICATOR&&(t=this._MIN_MULTIPLICATOR),t>this._MAX_MULTIPLICATOR&&(t=this._MAX_MULTIPLICATOR),this._startTime=this._getCurTime().getTime(),this._animationStartTime=(new Date).getTime(),this._multiplicator=t},TransitLayer.prototype.setCurrentTime=function(){this._startTime=(new Date).getTime(),this._animationStartTime=(new Date).getTime(),clearTimeout(this._partialTrajLoadTimer),this._requestTrajectories(!0)},TransitLayer.prototype.addVehicleSelectListener=function(t){this._vehicleSelectListeners.push(t)},TransitLayer.prototype.addTimeChangeListener=function(t){this._timeChangeListeners.push(t),t()},TransitLayer.prototype.setTrajectoryClient=function(t){this._trajectoryClient=t},TransitLayer.prototype._updateRaphaelViewport=function(t,e,i,r,a,s,o,n){this._curZoom=a,this._curPixelOrigin=s,this._curSw=o,this._curNe=n;var h=this._raphaelRoot;this._paper.setSize(i,r),h.style.left=t+"px",h.style.top=e+"px",h.setAttribute("width",i),h.setAttribute("height",r),this._paper.setViewBox(t,e,i,r,!1)},TransitLayer.prototype._updtVehTrajsList=function(t){$("#footLoading").hide();var e=t.rid;if(e==this._lastTrajectoriesRID){this._trajectories=t.a,this._curTimeZone=t.tz[0],time=this._getCurDTime();for(var i=0,r=this._trajectories.length;r>i;++i){var a=this._trajectories[i],s=this._markers[a.id];void 0!==s&&a.pts[0][0].at<=time&&(a.marker=s,s.data("hold",!0))}for(var i in this._markers){var s=this._markers[i];s.data("hold")?s.data("hold",!1):(void 0!==s.data("textOb")&&s.data("textOb").remove(),s.remove(),delete this._markers[i])}this._updtVehTrajs()}},TransitLayer.prototype._getTimeStep=function(t){var e=this._timeStepArray[t];return Math.min(1e3,Math.max(60,e/this._multiplicator))},TransitLayer.prototype._getDistance=function(t,e){return void 0!==t.p&&(t=t.p),void 0!==e.p&&(e=e.p),Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1]))},TransitLayer.prototype._getVehiclePositionAtTime=function(t,e){var i,r;i=void 0===e.curPt?0:e.curPt,r=void 0===e.curPos?0:e.curPos;for(var a=i,s=e.pts.length;s>a;++a){e.curPt=a;for(var o=e.pts[a],n=r,h=-1,c=-1,_=-1,l=-1,d=0,p=0;n<o.length&&(c=h,h=n,c>-1&&(p+=this._getDistance(o[c],o[h])),!(void 0!==o[h].dt&&(l=_,_=h,d=p,p=0,o[h].dt>t)));)n++;var u=o[_];if(!(0>_||u.dt<t)){if(u.at<t)return e.curPos=_,u.p;if(!(0>l)){var m=o[l],T=d*((t-m.dt)/(u.at-m.dt));return this._interpolate(e,o,l,_,T)}}}return!1},TransitLayer.prototype._interpolate=function(t,e,i,r,a){for(var s=0,o=0,n=i+1;r>=n;++n){o=s;var h=e[n],c=e[n-1];if(s+=this._getDistance(c,h),s>=a){var _=a-o;if(void 0!==h.p&&(h=h.p),void 0!==c.p&&(c=c.p),0>=_)return h;var l=c[0],d=c[1],p=h[0],u=h[1],m=p-l,T=u-d,y=Math.sqrt(m*m+T*T)/_;return t.curPos=i,[l+m/y,d+T/y]}}return!1},TransitLayer.prototype._updtVehTrajsPartial=function(t,e,i){for(var r=new Date,a=this._getCurDTime(),s=0,o=t,n=this._trajectories.length;n>o&&e>s;++o,++s){var h=this._trajectories[o],c=h.pts;if(!(c[0][0].at>a)){if(void 0!==h.marker){var _=c[c.length-1],l=_[_.length-1];l.dt<a&&(void 0!==h.marker.data("textOb")&&(2==l.t?h.marker.data("textOb").animate({opacity:0},500,"linear",function(){this.remove()}):h.marker.data("textOb").remove()),2==l.t?h.marker.animate({opacity:0},500,"linear",function(){this.remove()}):h.marker.remove(),delete this._markers[h.id],delete h.marker)}var d=this._getVehiclePositionAtTime(a,h);d?(this._vehicleCounter++,void 0===h.marker?(h.marker=this._getVehicleMarker(d,h),this._markers[h.id]=h.marker,1==c[0][0].t&&(h.marker.attr({opacity:0}),h.marker.animate({opacity:1},500,"linear"))):(h.marker.attr("cx",d[0]).attr("cy",d[1]),void 0!==h.marker.data("textOb")&&h.marker.data("textOb").attr("x",d[0]).attr("y",d[1]))):void 0!==h.marker&&(void 0!==h.marker.data("textOb")&&h.marker.data("textOb").remove(),h.marker.remove(),delete this._markers[h.id],delete h.marker)}}var p=this;if(this._currentTimeSum+=new Date-r,o<this._trajectories.length)this._partialTrajLoadTimer=setTimeout(function(){p._updtVehTrajsPartial(t+e,e,i)},i);else{if(this._statMode&&(this._currentTimeSampleCounter++,50==this._currentTimeSampleCounter)){var u="avg refresh time is "+this._currentTimeSum/100;u+="\ntimestep is "+i,u+="\ntime consumed per second is "+1e3/i*(this._currentTimeSum/100),u+="\nzoom level is "+this._map.getZoom(),u+="\nnumber of vehicles is "+this._vehicleCounter,alert(u),this._currentTimeSampleCounter=0,this._currentTimeSum=0}this._vehicleCounter=0,this._partialTrajLoadTimer=setTimeout(function(){p._loadPerCycle=p._newLoadPerCycle,p._updtVehTrajs(),p._timeStep=p._getTimeStep(p._curZoom)},i)}},TransitLayer.prototype._updtVehTrajs=function(){if(this._getCurTime()>this._trajectoryEndTime-1e3*this._multiplicator)return void this._requestTrajectories();var t=this._timeStep,e=t/Math.max(1,this._trajectories.length/this._loadPerCycle);this._updtVehTrajsPartial(0,this._loadPerCycle,e)},TransitLayer.prototype._getCurTime=function(){return new Date(this._startTime+this._multiplicator*((new Date).getTime()-this._animationStartTime))},TransitLayer.prototype._getCurDTime=function(){var t=this._getCurTime();if(t.getSeconds()!=this._oldTime.getSeconds())for(var e=0;e<this._vehicleSelectListeners.length;e++)this._timeChangeListeners[e]();return this._oldTime=t,t.getTime()/1e3},TransitLayer.prototype._requestTrajectories=function(){$("#footLoading").show(),this._lastTrajectoriesRID++;var t=this._getCurTime(),e=this;window._updtVehTrajsListDummy=function(t){e._updtVehTrajsList(t)},this._trajectoryEndTime=new Date(t.getTime()+this._multiplicator*this._LOOKAHEADSECONDS*1e3),this._trajectoryClient.getTrajectories(this._curSw.x-this._padding,this._curSw.y+this._padding,this._curNe.x+this._padding,this._curNe.y-this._padding,this._curPixelOrigin.x,this._curPixelOrigin.y,t.getUTCHours()+":"+t.getUTCMinutes()+":"+t.getUTCSeconds()+"."+10*t.getUTCMilliseconds(),this._trajectoryEndTime.getUTCHours()+":"+this._trajectoryEndTime.getUTCMinutes()+":"+this._trajectoryEndTime.getUTCSeconds()+"."+10*this._trajectoryEndTime.getUTCMilliseconds(),t.getUTCFullYear()+""+pad(t.getUTCMonth()+1,2)+pad(t.getUTCDate(),2),this._curZoom,"window._updtVehTrajsListDummy",this._lastTrajectoriesRID)},TransitLayer.prototype._latLngToPoint=function(t){return this._map.project(L.latLng(t))._subtract(this._map.getPixelOrigin())},TransitLayer.prototype._drawTrajectory=function(t){if(t.id==this._curHighLight){for(var e="",i=0;i<t.pts.length;i++)for(var r=t.pts[i],a=0;a<r.length;a++){var s;s=void 0===r[a].p?r[a]:r[a].p,e+=0==a?"M"+s[0]+","+s[1]:"L"+s[0]+","+s[1]}void 0!==this._highlightPath&&this._highlightPath.remove(),this._highlightPath=this._paper.path(e).attr({"stroke-width":6,stroke:"#fff600","stroke-linecap":"round","stroke-linejoin":"bevel","z-index":998});for(var o=this._paper.set(),i=0;i<t.pts.length;i++)for(var r=t.pts[i],a=0;a<r.length;a++){var s;void 0!==r[a].p&&(s=r[a].p,void 0!==r[a].n&&o.push(this._paper.circle(s[0],s[1],6).attr({fill:"#fff600",stroke:"#000","stroke-width":0,"z-index":999})))}void 0!==this._stationLabelSet&&this._stationLabelSet.remove(),this._stationLabelSet=o,this._markers[t.id]&&(this._markers[t.id].toFront(),this._markers[t.id].data("textOb")&&this._markers[t.id].data("textOb").toFront())}},TransitLayer.prototype._formatDelayTime=function(t){return t>=6e5?(t/6e5).toFixed(1):(t/1e4).toFixed(0)+"s"},TransitLayer.prototype.unselectVehicle=function(){this._selectedVeh&&(this._selectedVeh.data("selected",!1),this._selectVeh=void 0,this._unhighlightVehicle(this._selectedVeh))},TransitLayer.prototype.clearVehicleTraj=function(){delete this._curHighLight,void 0!==this._highlightPath&&(this._highlightPath.remove(),delete this._highlightPath),void 0!==this._stationLabelSet&&(this._stationLabelSet.remove(),delete this._stationLabelSet)},TransitLayer.prototype.showVehicleTraj=function(t,e){var i=this;this._curHighLight=t,window._drawTrajectoryDummy=function(t){i._drawTrajectory(t,e)},this._trajectoryClient.getTrajectory(this._curSw.x,this._curSw.y,this._curNe.x,this._curNe.y,this._curPixelOrigin.x,this._curPixelOrigin.y,t,this._curZoom,"window._drawTrajectoryDummy")},TransitLayer.prototype._selectVehicle=function(t){this._selectedVeh&&this.unselectVehicle(),this._selectedVeh=t;for(var e=0;e<this._vehicleSelectListeners.length;e++)this._vehicleSelectListeners[e](t.data("id"));t.attr("r",15),t.attr("stroke-width",3),t.data("selected",!0)},TransitLayer.prototype._getVehicleText=function(t,e,i,r,a){t.length>3&&(t=t.substring(0,1));var s=this,o=this._paper.text(r[0],r[1],t).attr({fill:i,stroke:i,"stroke-width":3==t.length?.3:.5,"font-size":3==t.length?e-5:e+2,"font-family":"Verdana,Trebuchet MS, Helvetica, sans-serif",cursor:"pointer"}).mouseover(function(){s._highlightVehicle(a,15)}).mouseout(function(){s._unhighlightVehicle(a)}).click(function(){s._selectVehicle(a)});return o},TransitLayer.prototype._getVehicleMarker=function(t,e){var i=this._standardBgColor[e.t],r=this._standardTextColor[e.t],a="";e.sn&&(a=e.sn),e.c&&""!=e.c&&(i="#"+e.c),e.tc&&""!=e.tc&&(r="#"+e.tc);var s=this._getPWidth(e.t),o=this,n=this._paper.circle(t[0],t[1],s).attr({fill:"#fff",stroke:"#000","stroke-width":2,fill:i,cursor:"pointer"});if(n.data("lbl",a),n.data("veh",e),s>8&&""!=a){var h=this._getVehicleText(a,s,r,t,n);n.data("textOb",h),h.toFront()}return n.mouseover(function(){o._highlightVehicle(this,15)}),n.mouseout(function(){o._unhighlightVehicle(this)}),n.click(function(){o._selectVehicle(this)}),n.data("id",e.id)},TransitLayer.prototype._highlightVehicle=function(t,e){if(t.stop(),void 0===t.data("textOb")){var i=this._standardTextColor[t.data("veh").t];t.data("veh").tc&&(i="#"+t.data("veh").tc);var r=this._getVehicleText(t.data("lbl"),t.attr("r"),i,new Array(t.attr("cx"),t.attr("cy")),t);t.data("textOb",r),t.data("textOb").toFront()}t.data("textOb").stop(),(window.chrome||null!=window.mozInnerScreenX)&&(t.toFront(),t.data("textOb").toFront()),this._pulseEnabled&&void 0===t.data("pulse")&&!t.data("pulsed")&&(t.data("pulse",this._paper.circle(t.attrs.cx,t.attrs.cy,t.attrs.r)),t.data("pulse").attr({opacity:.7}),t.data("pulsed",!0),t.data("pulse").animate({r:30,opacity:0},500,">",function(){this.remove,t.removeData("pulse")})),t.animate({r:e},150),3==t.data("textOb").attr("text").length?t.data("textOb").animate({"font-size":e-2},150):t.data("textOb").animate({"font-size":e+2},150)},TransitLayer.prototype._unhighlightVehicle=function(t){if(!t.data("selected")&&t.data("veh")){var e=this._getPWidth(t.data("veh").t);if(t.stop(),t.animate({"stroke-width":2,r:e},150,"linear",function(){t.data("pulsed",!1)}),void 0!==t.data("textOb")){t.data("textOb").stop();var i;i=3==t.data("textOb").attr("text").length?e-5:e+2,t.data("textOb").animate({"font-size":8>i?8:i},100,"linear",function(){9>e&&(this.remove(),t.data("textOb",void 0))})}}},TransitLayer.prototype._getPWidth=function(t){switch(z=this._curZoom,t){case 0:return Math.min(11,parseInt((z-1)*(z-1)/27));case 1:return Math.min(11,parseInt(z*z/23));case 2:return Math.max(3,Math.min(11,parseInt(z*z/14)));case 3:return Math.min(11,parseInt((z-2)*(z-2)/26));case 4:return Math.min(11,parseInt(z*z/23));case 5:return Math.min(11,parseInt((z-2)*(z-2)/24));case 6:return Math.min(11,parseInt((z-2)*(z-2)/24));case 7:return Math.min(11,parseInt((z-2)*(z-2)/24))}return 1},TransitLayer.prototype.getStandardBgColor=function(t){return this._standardBgColor[t]},TransitLayer.prototype.getStandardTextColor=function(t){return this._standardTextColor[t]},TransitLayer.prototype.getVehicleTypeName=function(t){return this._vehicleTypes[t]},TransitLayer.prototype._getTimeString=function(t){var e=t/36e6>>0,i=t%36e6/6e5>>0,r=t%36e6%6e5/1e4>>0;return 0==r?pad(e,2)+":"+pad(i,2):pad(e,2)+":"+pad(i,2)+":"+pad(r,2)},TransitLayer.prototype._getDelayString=function(t){var e=t/36e6>>0,i=t%36e6/6e5>>0,r=t%36e6%6e5/1e4>>0;return 0==r&&0==e?pad(i,2)+"m":0==r?pad(e,2)+"h"+pad(i,2)+"m":0==i&&0==e?pad(r,2)+"s":0==e?pad(i,2)+"m"+pad(r,2)+"s":pad(e,2)+"h"+pad(i,2)+"m"+pad(r,2)+"s"};